
# Hermes 后端架构设计文档

## 🧭 项目概述

Hermes 是一个基于 GMX v2 的多用户加密货币策略交易执行引擎，提供链上策略调度、资金管理、风控系统、API 控制与策略自动执行服务。

---

## 📦 模块结构

### 核心模块职责

| 模块                     | 类型       | 核心职责 |
|--------------------------|------------|----------|
| Hermes API 服务          | Express/Koa | 提供策略控制、账户查询、手动调试接口 |
| 策略调度系统             | Node 服务   | 周期性拉取链上策略并判断执行时机 |
| 交易执行器               | Node 服务   | 执行策略合约调用（开仓/平仓） |
| 资金池管理器             | 内部模块     | 管理链上资金池合约状态，处理充值提现 |
| 市场数据模块             | 服务/SDK    | 获取实时行情（价格/K线/波动率） |
| 事件监听器               | 内部模块     | 监听链上事件并更新执行状态 |
| 风控模块                 | 内部模块     | 风险控制：滑点、频率、重复触发 |
| 日志与监控模块           | 日志服务     | 输出系统日志、执行记录和健康状态 |

---

## 🗂️ 项目结构建议

```
hermes-backend/
├── src/
│   ├── api/                # Hermes API 服务
│   ├── scheduler/          # 策略调度与判断模块
│   ├── executor/           # 执行器模块
│   ├── contracts/          # 合约 ABI 和调用封装
│   ├── chains/             # 链配置与 RPC 连接
│   ├── services/           # 价格服务封装
│   ├── events/             # 链上事件监听模块
│   ├── risk/               # 风控处理模块
│   ├── utils/              # 通用工具函数
│   └── logs/               # 日志系统
```

---

## 🔌 Hermes API 接口设计

### 1. `/api/strategy` 策略控制

| 路径         | 方法 | 说明 |
|--------------|------|------|
| `/start`     | POST | 启动某个策略 |
| `/stop`      | POST | 停止策略运行 |
| `/update`    | POST | 更新策略参数 |
| `/trigger`   | POST | 手动触发策略执行（调试用） |
| `/list`      | GET  | 获取用户所有策略状态 |

### 2. `/api/account` 账户与资金池

| 路径           | 方法 | 说明 |
|----------------|------|------|
| `/status`      | GET  | 查询授权状态、资金余额 |
| `/deposit`     | POST | 提交充值 |
| `/withdraw`    | POST | 提交提现 |
| `/history`     | GET  | 查看资金流动历史 |
| `/positions`   | GET  | 当前持仓状态 |

### 3. `/api/admin` 管理接口

| 路径              | 方法 | 说明 |
|-------------------|------|------|
| `/force-close`    | POST | 强制平仓某用户策略 |
| `/clear-cache`    | POST | 清除缓存 |
| `/resync-events`  | POST | 重新同步事件 |
| `/restart-user-task` | POST | 重启用户策略调度任务 |

---

## 🔁 策略执行流程

1. 周期性扫描链上策略
2. 拉取实时市场行情
3. 判断是否满足策略触发条件
4. 满足则执行链上交易（开仓/平仓）
5. 写入执行日志，返回前端状态更新

---

## 🔒 风控机制建议

- 滑点控制
- 最大持仓限制
- 冷却时间限制
- 重复调用检测
- 策略执行失败重试机制

---

## 📊 数据源配置

| 数据类型 | 推荐来源 |
|----------|----------|
| 实时价格 | GMX API / CCXT |
| K线数据 | Binance / OKX API |
| 波动率  | 本地计算或链外服务 |

---

## ✅ 总结

Hermes 是系统中负责执行、调度、风控、接口、合约调用的核心后端组件，需具备可扩展、可维护、高可用、高安全的能力。此文档提供完整的模块职责与 API 接口设计，便于团队开发与部署。
