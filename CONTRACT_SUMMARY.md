# Hermes 交易机器人合约架构总结

## 项目概述

Hermes 是一个基于智能合约的加密货币交易策略机器人系统，采用模块化设计，支持资金池管理、会员系统、策略执行和模拟交易功能。

## 核心合约架构

### 1. 主控制器 (HermesController)
- **功能**: 统一入口，协调所有模块
- **特点**: 
  - 实现 `IHermesController` 接口
  - 支持暂停/恢复功能
  - 费用收集和分发
  - 用户权限管理

### 2. 模块化设计

#### 2.1 资金池管理 (PoolManager)
- **功能**: 管理用户资金池
- **特点**:
  - 创建、存款、提款操作
  - 基于会员类型的限制
  - 费用自动扣除
  - 余额查询和统计

#### 2.2 会员管理 (MembershipManager) ⭐ **已简化**
- **功能**: 管理用户会员状态
- **新的简化系统**:
  - **会员类型**: 只有非会员(FREE)和会员(MEMBER)两种
  - **时长选项**: 月付(30天)、季度(90天)、年付(365天)
  - **价格**: 月付50 USDT、季度120 USDT、年付400 USDT
  - **费用率**: 非会员5%、会员1%
  - **功能限制**: 非会员(1池/2策略)、会员(10池/20策略)
  - **续费机制**: 支持自动延长会员期限

#### 2.3 策略管理 (StrategyManager)
- **功能**: 管理交易策略
- **特点**:
  - 创建、执行、查询策略
  - 策略状态管理(活跃/非活跃)
  - 基于会员类型的限制
  - 策略执行记录

#### 2.4 模拟交易 (MockGMX)
- **功能**: 模拟GMX V2交易环境
- **特点**:
  - 预设交易对(BTC/USD, ETH/USD等)
  - 模拟价格数据
  - 交易执行模拟
  - 市场状态查询

### 3. 代币合约 (MockUSDT)
- **功能**: 测试用USDT代币
- **特点**:
  - ERC20标准实现
  - 6位小数精度
  - 用户可自行领取测试代币
  - 支持铸造和销毁

## 技术特性

### 安全机制
- **访问控制**: 基于OpenZeppelin的Role-Based Access Control
- **重入攻击防护**: 使用ReentrancyGuard
- **暂停机制**: 支持紧急暂停所有操作
- **费用验证**: 严格的费用计算和验证

### 费用系统
- **动态费用率**: 基于会员状态自动调整
- **费用收集**: 统一收集到指定地址
- **费用提取**: 管理员可提取收集的费用
- **白名单**: 特殊用户可享受0%费用率

### 权限管理
- **角色定义**:
  - `DEFAULT_ADMIN_ROLE`: 超级管理员
  - `ADMIN_ROLE`: 管理员
  - `OPERATOR_ROLE`: 操作员
  - `WHITELIST_ROLE`: 白名单管理员

## 部署配置

### 环境变量
- `FEE_COLLECTOR_ADDRESS`: 费用收集地址(必需)

### 部署流程
1. 部署MockUSDT代币
2. 部署HermesController主合约
3. 自动部署所有模块合约
4. 初始化模块间关联
5. 设置权限和角色

## 测试覆盖

### 测试用例 (14个)
- ✅ 合约部署验证
- ✅ 资金池管理功能
- ✅ 策略管理功能
- ✅ 会员管理功能(简化后)
- ✅ 费用管理功能
- ✅ 访问控制功能
- ✅ 模拟交易功能

### 测试网络
- Hardhat本地网络
- 支持localhost网络部署

## 前端集成

### 用户操作流程
1. **获取测试代币**: 调用`MockUSDT.mintForTesting()`
2. **购买会员**: 调用`upgradeMembership(duration)`
3. **创建资金池**: 调用`createPool(name, description)`
4. **存入资金**: 调用`depositToPool(poolId, amount)`
5. **创建策略**: 调用`createStrategy(poolId, name, description, data)`
6. **执行策略**: 调用`executeStrategy(strategyId)`

### API接口
- 所有合约函数都通过主控制器`HermesController`调用
- 支持批量操作和权限管理
- 提供完整的查询接口

## 扩展性设计

### 模块化架构
- 各模块独立部署和升级
- 通过接口进行模块间通信
- 支持新模块的添加

### 配置灵活性
- 费用率可通过合约升级调整
- 会员价格可通过常量修改
- 支持多网络部署

## 安全审计要点

### 已实现的安全措施
- ✅ 重入攻击防护
- ✅ 访问控制验证
- ✅ 输入参数验证
- ✅ 费用计算准确性
- ✅ 余额检查机制

### 建议的安全措施
- 🔄 第三方安全审计
- 🔄 形式化验证
- 🔄 多签名钱包集成
- 🔄 时间锁机制

## 维护和升级

### 合约升级策略
- 模块化设计支持独立升级
- 主控制器可升级以添加新功能
- 数据迁移方案

### 监控和告警
- 事件日志记录所有关键操作
- 费用收集监控
- 异常交易检测

---

**最后更新**: 2024年12月
**版本**: 2.0 (简化会员系统)
**状态**: ✅ 开发完成，测试通过 